<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>作業報告（30ページ・縦長画像禁止版）</title>
  <style>
    @page { size: A4 portrait; margin: 8mm; }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
    }
    .container {
      width: 100%;
      max-width: 740px;
      margin: auto;
      padding: 6mm;
      background: white;
      box-sizing: border-box;
    }
    .section { margin-bottom: 8px; }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
      color: #003366;
    }
    input, textarea {
      width: 100%;
      padding: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { resize: vertical; }
    .row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .title-wide { flex: 2; }
    .date-narrow { flex: 0.7; }
    .photo-block {
      display: flex;
      align-items: stretch;
      gap: 8px;
      margin-bottom: 10px;
      page-break-inside: avoid;
      border: 1px solid #cccccc;
      border-radius: 4px;
      padding: 4px;
      background-color: #ffffff;
    }
    .photo-label {
      writing-mode: vertical-rl;
      text-align: center;
      font-weight: bold;
      font-size: 13px;
      width: 28px;
      flex: 0 0 28px;
      color: #004080;
    }
    .photo-image-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      flex: 0 0 auto;
    }
    .photo-block img {
      width: 300px;
      max-height: 220px;
      object-fit: contain;
      border: 1px solid #aaaaaa;
      background: #fff;
      cursor: pointer;
      transition: transform 0.2s ease;
      display: block;
    }
    .photo-block img:hover { transform: scale(1.02); }
    .photo-comment { flex: 1 1 auto; height: 220px; }
    .button-bar {
      text-align: center;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      margin: 6px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    select {
      font-size: 14px;
      padding: 6px;
      margin: 6px;
    }
    .nav-bar {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 6px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .report { display: none; page-break-after: always; }
    .report.active { display: block; }
    .char-warning {
      color: red;
      font-size: 12px;
      display: none;
    }
    @media print {
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      body {
        background: white !important;
      }
      .nav-bar, .button-bar, input[type=file], button, select { display: none !important; }
      .report { display: none !important; }
      .report.print-target { display: block !important; }
    }
  </style>
</head>
<body>

  <div class="nav-bar">
    <label for="pageSelect">ページ選択：</label>
    <select id="pageSelect"></select>
  </div>

  <div id="reportsContainer"></div>

  <div class="button-bar">
    <button id="btnPrintCurrent">この報告書だけ印刷</button>
    <button id="btnPrintAll">すべての報告書を印刷</button>
  </div>

<script>
// 全角換算文字数をカウント
function getZenkakuLength(str) {
  let len = 0;
  for (let ch of str) {
    len += ch.match(/[ -~]/) ? 1 : 2;
  }
  return len;
}

// 文字数制限（警告1つのみ）
function applyCharLimit(el, maxLength) {
  if (el.dataset.limited) return;
  el.dataset.limited = "true";

  const warning = document.createElement('div');
  warning.className = 'char-warning';
  warning.textContent = `⚠ 最大${maxLength / 2}文字（全角）まで入力可能です。`;
  el.parentNode.appendChild(warning);

  el.addEventListener('input', () => {
    const len = getZenkakuLength(el.value);
    warning.style.display = (len > maxLength) ? 'block' : 'none';
    if (len > maxLength) el.value = el.value.slice(0, -1);
  });
}

// ページ生成
const reportsContainer = document.getElementById('reportsContainer');
for (let i = 1; i <= 30; i++) {
  const div = document.createElement('div');
  div.className = 'report';
  div.id = 'report-' + i;
  div.innerHTML = `
  <div class="container">
    <div class="section row">
      <div class="title-wide">
        <label for="title-${i}">タイトル</label>
        <input type="text" id="title-${i}" placeholder="作業タイトル（${i}ページ目）">
      </div>
      <div class="date-narrow">
        <label for="date-${i}">日付</label>
        <input type="date" id="date-${i}">
      </div>
    </div>
    <div class="section">
      <label for="worker-${i}">作業員名</label>
      <textarea id="worker-${i}" rows="2" placeholder="例：山田 太郎\n佐藤 花子"></textarea>
    </div>
    <div class="section">
      <div class="photo-block">
        <div class="photo-label">作業前</div>
        <div class="photo-image-wrap">
          <img id="preview-before-${i}" src="">
          <input type="file" accept="image/*" onchange="previewImage(event, '${i}', 'before')">
        </div>
        <textarea class="photo-comment" placeholder="作業前のコメント"></textarea>
      </div>
      <div class="photo-block">
        <div class="photo-label">作業中</div>
        <div class="photo-image-wrap">
          <img id="preview-middle-${i}" src="">
          <input type="file" accept="image/*" onchange="previewImage(event, '${i}', 'middle')">
        </div>
        <textarea class="photo-comment" placeholder="作業中のコメント"></textarea>
      </div>
      <div class="photo-block">
        <div class="photo-label">作業後</div>
        <div class="photo-image-wrap">
          <img id="preview-after-${i}" src="">
          <input type="file" accept="image/*" onchange="previewImage(event, '${i}', 'after')">
        </div>
        <textarea class="photo-comment" placeholder="作業後のコメント"></textarea>
      </div>
    </div>
    <div class="section">
      <label for="notes-${i}">備考</label>
      <textarea id="notes-${i}" rows="3" placeholder="備考を記入"></textarea>
    </div>
  </div>`;
  reportsContainer.appendChild(div);
}

// ドロップダウン生成
const pageSelect = document.getElementById('pageSelect');
for (let i = 1; i <= 30; i++) {
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = `報告書 ${i}`;
  pageSelect.appendChild(opt);
}

let currentPage = 1;
pageSelect.addEventListener('change', () => showReport(parseInt(pageSelect.value)));
function showReport(num) {
  document.querySelectorAll('.report').forEach(r => r.classList.remove('active'));
  document.getElementById('report-' + num).classList.add('active');
  pageSelect.value = num;
  currentPage = num;
  setCharLimits();
}
showReport(1);

// 画像プレビュー（縦長禁止）
function previewImage(event, id, slot) {
  const file = event.target.files[0];
  if (!file) return;

  const tempImg = new Image();
  tempImg.onload = function() {
    if (tempImg.height > tempImg.width) {
      alert("⚠ 縦長の画像は添付できません。横長の写真を選択してください。");
      event.target.value = "";
      return;
    }
    const reader = new FileReader();
    reader.onload = function() {
      document.getElementById(`preview-${slot}-${id}`).src = reader.result;
    };
    reader.readAsDataURL(file);
  };
  tempImg.src = URL.createObjectURL(file);
}

// 印刷制御
function setPrintTargets(pages) {
  document.querySelectorAll('.report.print-target').forEach(el => el.classList.remove('print-target'));
  pages.forEach(n => {
    const el = document.getElementById('report-' + n);
    if (el) el.classList.add('print-target');
  });
}
function restoreAfterPrint(previousActive) {
  document.querySelectorAll('.report.print-target').forEach(el => el.classList.remove('print-target'));
  showReport(previousActive);
}

// 文字数制限適用
function setCharLimits() {
  document.querySelectorAll('input[id^="title-"]').forEach(el => applyCharLimit(el, 60)); // 全角30
  document.querySelectorAll('textarea[id^="worker-"]').forEach(el => applyCharLimit(el, 100)); // 全角50
  document.querySelectorAll('.photo-comment').forEach(el => applyCharLimit(el, 200)); // 全角100
  document.querySelectorAll('textarea[id^="notes-"]').forEach(el => applyCharLimit(el, 140)); // 全角70
}
setCharLimits();

// 印刷
document.getElementById('btnPrintCurrent').addEventListener('click', () => {
  const prev = currentPage;
  setPrintTargets([currentPage]);
  const fallback = setTimeout(() => restoreAfterPrint(prev), 1500);
  window.addEventListener('afterprint', function handler() {
    clearTimeout(fallback);
    restoreAfterPrint(prev);
    window.removeEventListener('afterprint', handler);
  });
  window.print();
});

document.getElementById('btnPrintAll').addEventListener('click', () => {
  const allReports = document.querySelectorAll('.report');
  const pages = [];

  allReports.forEach((report, idx) => {
    const imgs = Array.from(report.querySelectorAll('img'));
    const hasPhoto = imgs.some(img => {
      const src = (img.getAttribute('src') || '').trim();
      return src.startsWith('data:image');
    });
    if (hasPhoto) pages.push(idx + 1);
  });

  if (pages.length === 0) {
    alert('印刷対象となる写真付き報告書がありません。');
    return;
  }

  const confirmMsg = `印刷対象ページ: ${pages.join(', ')}\n\n印刷を実行しますか？`;
  if (!confirm(confirmMsg)) return;

  const prev = currentPage;
  setPrintTargets(pages);
  const fallback = setTimeout(() => restoreAfterPrint(prev), 1500);
  window.addEventListener('afterprint', function handler() {
    clearTimeout(fallback);
    restoreAfterPrint(prev);
    window.removeEventListener('afterprint', handler);
  });
  window.print();
});
</script>
</body>
</html>
